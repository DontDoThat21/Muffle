<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Muffle.ViewModels"
             xmlns:models="clr-namespace:Muffle.Data.Models;assembly=Muffle.Data"
             x:Class="Muffle.Views.FriendRequestsView"
             x:DataType="viewmodels:FriendRequestsViewModel"
             BackgroundColor="#303030">
    
    <Grid RowDefinitions="Auto,Auto,*" Padding="20" RowSpacing="15">
        
        <!-- Header -->
        <VerticalStackLayout Grid.Row="0" Spacing="10">
            <Label Text="Friend Requests" 
                   FontSize="24" 
                   FontAttributes="Bold" 
                   TextColor="White"/>
            <Label Text="Manage your pending friend requests" 
                   FontSize="14" 
                   TextColor="LightGray"/>
        </VerticalStackLayout>

        <!-- Tab Selector -->
        <Grid Grid.Row="1" ColumnDefinitions="*,*" ColumnSpacing="10">
            <Button Grid.Column="0"
                    Text="{Binding IncomingRequestCount, StringFormat='Incoming ({0})'}"
                    BackgroundColor="{Binding SelectedTabIndex, Converter={StaticResource TabBackgroundConverter}, ConverterParameter=0}"
                    TextColor="White"
                    CornerRadius="4"
                    Padding="0,10"
                    Clicked="IncomingTab_Clicked"/>
            
            <Button Grid.Column="1"
                    Text="{Binding OutgoingRequestCount, StringFormat='Outgoing ({0})'}"
                    BackgroundColor="{Binding SelectedTabIndex, Converter={StaticResource TabBackgroundConverter}, ConverterParameter=1}"
                    TextColor="White"
                    CornerRadius="4"
                    Padding="0,10"
                    Clicked="OutgoingTab_Clicked"/>
        </Grid>

        <!-- Content Area -->
        <ScrollView Grid.Row="2">
            <VerticalStackLayout Spacing="10">
                
                <!-- Loading Indicator -->
                <ActivityIndicator IsVisible="{Binding IsLoading}" 
                                 IsRunning="{Binding IsLoading}"
                                 Color="White"
                                 HorizontalOptions="Center"
                                 VerticalOptions="Center"
                                 Margin="0,40,0,0"/>

                <!-- Status Message -->
                <Label Text="{Binding StatusMessage}" 
                       IsVisible="{Binding HasStatusMessage}"
                       HorizontalOptions="Center"
                       TextColor="LightGray"
                       FontSize="14"
                       Margin="0,20,0,0"/>

                <!-- Incoming Requests Tab -->
                <VerticalStackLayout Spacing="10" IsVisible="{Binding SelectedTabIndex, Converter={StaticResource TabVisibilityConverter}, ConverterParameter=0}">
                    
                    <!-- No Incoming Requests -->
                    <Label Text="No incoming friend requests" 
                           IsVisible="{Binding HasIncomingRequests, Converter={StaticResource InverseBoolConverter}}"
                           HorizontalOptions="Center"
                           TextColor="Gray"
                           FontSize="14"
                           Margin="0,40,0,0"/>

                    <!-- Incoming Requests List -->
                    <CollectionView ItemsSource="{Binding IncomingRequests}"
                                  IsVisible="{Binding HasIncomingRequests}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:FriendRequest">
                                <Frame Padding="15" 
                                       Margin="0,5,0,5" 
                                       BorderColor="#424242"
                                       BackgroundColor="#252525"
                                       CornerRadius="8"
                                       HasShadow="False">
                                    <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15" RowDefinitions="Auto,Auto" RowSpacing="10">
                                        
                                        <!-- Avatar -->
                                        <Frame Grid.Column="0" 
                                               Grid.RowSpan="2"
                                               WidthRequest="50" 
                                               HeightRequest="50" 
                                               CornerRadius="25"
                                               Padding="0"
                                               HasShadow="False"
                                               BackgroundColor="#7289DA"
                                               VerticalOptions="Start">
                                            <Label Text="{Binding SenderName, StringFormat='{0:C1}'}" 
                                                   FontSize="20"
                                                   FontAttributes="Bold"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"
                                                   TextColor="White"/>
                                        </Frame>

                                        <!-- User Info -->
                                        <VerticalStackLayout Grid.Column="1" Grid.Row="0" VerticalOptions="Center" Spacing="3">
                                            <Label Text="{Binding SenderFullUsername}" 
                                                   FontSize="16" 
                                                   FontAttributes="Bold"
                                                   TextColor="White"/>
                                            <Label Text="{Binding SenderEmail}" 
                                                   FontSize="12" 
                                                   TextColor="LightGray"/>
                                            <Label Text="{Binding CreatedAt, StringFormat='Sent: {0:g}'}" 
                                                   FontSize="10" 
                                                   TextColor="Gray"/>
                                        </VerticalStackLayout>

                                        <!-- Action Buttons -->
                                        <HorizontalStackLayout Grid.Column="1" Grid.Row="1" Grid.ColumnSpan="2" Spacing="10" HorizontalOptions="End">
                                            <Button Text="Accept" 
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:FriendRequestsViewModel}}, Path=AcceptRequestCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#43B581"
                                                    TextColor="White"
                                                    CornerRadius="4"
                                                    Padding="20,8"/>
                                            <Button Text="Decline" 
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:FriendRequestsViewModel}}, Path=DeclineRequestCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#F04747"
                                                    TextColor="White"
                                                    CornerRadius="4"
                                                    Padding="20,8"/>
                                        </HorizontalStackLayout>
                                        
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!-- Outgoing Requests Tab -->
                <VerticalStackLayout Spacing="10" IsVisible="{Binding SelectedTabIndex, Converter={StaticResource TabVisibilityConverter}, ConverterParameter=1}">
                    
                    <!-- No Outgoing Requests -->
                    <Label Text="No outgoing friend requests" 
                           IsVisible="{Binding HasOutgoingRequests, Converter={StaticResource InverseBoolConverter}}"
                           HorizontalOptions="Center"
                           TextColor="Gray"
                           FontSize="14"
                           Margin="0,40,0,0"/>

                    <!-- Outgoing Requests List -->
                    <CollectionView ItemsSource="{Binding OutgoingRequests}"
                                  IsVisible="{Binding HasOutgoingRequests}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:FriendRequest">
                                <Frame Padding="15" 
                                       Margin="0,5,0,5" 
                                       BorderColor="#424242"
                                       BackgroundColor="#252525"
                                       CornerRadius="8"
                                       HasShadow="False">
                                    <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15">
                                        
                                        <!-- Avatar -->
                                        <Frame Grid.Column="0" 
                                               WidthRequest="50" 
                                               HeightRequest="50" 
                                               CornerRadius="25"
                                               Padding="0"
                                               HasShadow="False"
                                               BackgroundColor="#7289DA">
                                            <Label Text="{Binding ReceiverName, StringFormat='{0:C1}'}" 
                                                   FontSize="20"
                                                   FontAttributes="Bold"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"
                                                   TextColor="White"/>
                                        </Frame>

                                        <!-- User Info -->
                                        <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="3">
                                            <Label Text="{Binding ReceiverFullUsername}" 
                                                   FontSize="16" 
                                                   FontAttributes="Bold"
                                                   TextColor="White"/>
                                            <Label Text="{Binding ReceiverEmail}" 
                                                   FontSize="12" 
                                                   TextColor="LightGray"/>
                                            <Label Text="{Binding CreatedAt, StringFormat='Sent: {0:g}'}" 
                                                   FontSize="10" 
                                                   TextColor="Gray"/>
                                            <Label Text="Pending..." 
                                                   FontSize="11" 
                                                   TextColor="Orange"
                                                   FontAttributes="Italic"/>
                                        </VerticalStackLayout>

                                        <!-- Cancel Button -->
                                        <Button Grid.Column="2" 
                                                Text="Cancel" 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:FriendRequestsViewModel}}, Path=CancelRequestCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="#F04747"
                                                TextColor="White"
                                                CornerRadius="4"
                                                Padding="20,8"
                                                VerticalOptions="Center"/>
                                        
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!-- Refresh Button -->
                <Button Text="Refresh" 
                        Command="{Binding RefreshCommand}"
                        BackgroundColor="#7289DA"
                        TextColor="White"
                        CornerRadius="4"
                        Padding="0,12"
                        Margin="0,20,0,0"/>
                
            </VerticalStackLayout>
        </ScrollView>
        
    </Grid>
</ContentView>
