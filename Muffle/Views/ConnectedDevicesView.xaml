<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Muffle.ViewModels"
             xmlns:models="clr-namespace:Muffle.Data.Models;assembly=Muffle.Data"
             x:Class="Muffle.Views.ConnectedDevicesView"
             x:DataType="viewmodels:ConnectedDevicesViewModel"
             BackgroundColor="#303030">

    <Grid RowDefinitions="Auto,Auto,*" Padding="20" RowSpacing="15">

        <!-- Header -->
        <VerticalStackLayout Grid.Row="0" Spacing="10">
            <Label Text="Connected Devices"
                   FontSize="24"
                   FontAttributes="Bold"
                   TextColor="White"/>
            <Label Text="Active login sessions on your account â€” log out devices you don't recognize"
                   FontSize="14"
                   TextColor="LightGray"/>
        </VerticalStackLayout>

        <!-- Status Message -->
        <Label Grid.Row="1"
               Text="{Binding StatusMessage}"
               IsVisible="{Binding HasStatusMessage}"
               HorizontalOptions="Center"
               TextColor="Orange"
               FontSize="14"
               FontAttributes="Bold"/>

        <!-- Content Area -->
        <ScrollView Grid.Row="2">
            <VerticalStackLayout Spacing="10">

                <!-- Loading Indicator -->
                <ActivityIndicator IsVisible="{Binding IsLoading}"
                                   IsRunning="{Binding IsLoading}"
                                   Color="White"
                                   HorizontalOptions="Center"
                                   Margin="0,40,0,0"/>

                <!-- No Sessions Message -->
                <Label Text="No active sessions found."
                       IsVisible="{Binding HasSessions, Converter={StaticResource InverseBoolConverter}}"
                       HorizontalOptions="Center"
                       TextColor="Gray"
                       FontSize="14"
                       Margin="0,40,0,0"/>

                <!-- Sessions List -->
                <CollectionView ItemsSource="{Binding Sessions}"
                                IsVisible="{Binding HasSessions}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:UserSession">
                            <Frame Padding="15"
                                   Margin="0,5,0,5"
                                   BorderColor="#424242"
                                   BackgroundColor="#252525"
                                   CornerRadius="8"
                                   HasShadow="False">
                                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15">

                                    <!-- Platform Icon -->
                                    <Frame Grid.Column="0"
                                           WidthRequest="50"
                                           HeightRequest="50"
                                           CornerRadius="25"
                                           Padding="0"
                                           HasShadow="False"
                                           BackgroundColor="#7289DA">
                                        <Label Text="{Binding Platform, StringFormat='{0:C1}'}"
                                               FontSize="20"
                                               FontAttributes="Bold"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center"
                                               TextColor="White"/>
                                    </Frame>

                                    <!-- Session Info -->
                                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="3">
                                        <Label Text="{Binding DeviceName}"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               TextColor="White"/>
                                        <Label Text="{Binding Platform}"
                                               FontSize="12"
                                               TextColor="LightGray"/>
                                        <Label Text="{Binding IpAddressDisplay, StringFormat='IP: {0}'}"
                                               FontSize="11"
                                               TextColor="LightGray"/>
                                        <Label Text="{Binding CreatedAt, StringFormat='Logged in: {0:g}'}"
                                               FontSize="10"
                                               TextColor="Gray"/>
                                        <Label Text="{Binding LastUsedDisplay, StringFormat='Last active: {0}'}"
                                               FontSize="10"
                                               TextColor="Gray"/>
                                        <Label Text="{Binding ExpiresAt, StringFormat='Expires: {0:g}'}"
                                               FontSize="10"
                                               TextColor="Gray"/>
                                        <!-- Current Session Badge -->
                                        <Frame IsVisible="{Binding IsCurrentSession}"
                                               BackgroundColor="#43B581"
                                               BorderColor="Transparent"
                                               CornerRadius="4"
                                               Padding="6,2"
                                               HorizontalOptions="Start"
                                               HasShadow="False">
                                            <Label Text="Current Session"
                                                   FontSize="10"
                                                   FontAttributes="Bold"
                                                   TextColor="White"/>
                                        </Frame>
                                    </VerticalStackLayout>

                                    <!-- Revoke Button (hidden for current session) -->
                                    <Button Grid.Column="2"
                                            Text="Revoke"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ConnectedDevicesViewModel}}, Path=RevokeSessionCommand}"
                                            CommandParameter="{Binding .}"
                                            IsVisible="{Binding IsCurrentSession, Converter={StaticResource InverseBoolConverter}}"
                                            BackgroundColor="#F04747"
                                            TextColor="White"
                                            CornerRadius="4"
                                            Padding="15,8"
                                            VerticalOptions="Center"/>

                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Log Out All Other Devices Button -->
                <Button Text="Log Out All Other Devices"
                        Command="{Binding RevokeAllOtherSessionsCommand}"
                        IsVisible="{Binding HasOtherSessions}"
                        BackgroundColor="#F04747"
                        TextColor="White"
                        FontAttributes="Bold"
                        CornerRadius="8"
                        Padding="15,10"
                        Margin="0,10,0,0"
                        HorizontalOptions="FillAndExpand"/>

                <!-- Refresh Button -->
                <Button Text="Refresh"
                        Command="{Binding RefreshCommand}"
                        BackgroundColor="#7289DA"
                        TextColor="White"
                        CornerRadius="8"
                        Padding="15,10"
                        HorizontalOptions="FillAndExpand"/>

            </VerticalStackLayout>
        </ScrollView>

    </Grid>

</ContentView>
